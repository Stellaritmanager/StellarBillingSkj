USE [StellarBilling]
GO
/****** Object:  UserDefinedFunction [dbo].[GeneratePointsID]    Script Date: 31-07-2024 11:47:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER FUNCTION [dbo].[GeneratePointsID](
    @pCustomerNumber as Varchar(100),
	@BranchID as varchar (50)
)
RETURNS VARCHAR(50)
AS
BEGIN
    DECLARE @PointsID NVARCHAR(50)
	
    Declare @NetPoints float 
    Declare @usedPoints int

    --Get the netpoints
    Select @NetPoints=convert(float,NetPoints)/Convert(float,NetPrice) from [dbo].[SHPointsMaster]

    select @PointsID=convert(Varchar, (sum(convert(float,PaymentAMount)))*@NetPoints) from [dbo].[SHPaymentDetails] where IsDelete=0 and PaymentId in 
    (select PaymentID from SHPaymentMaster where CustomerNumber=@pCustomerNumber and BranchID=@BranchID) 


    select @usedPoints=sum(convert(int,isnull(ReedemPoints,'0')))  from SHReedemHistory where CustomerNumber=@pCustomerNumber and BranchID=@BranchID
    group by CustomerNumber
    
    if((convert(int,@PointsID)-isnull(convert(int,@usedPoints),0))>0)
    Begin
    select @PointsID = Convert(int,@PointsID)-isnull(@usedPoints,0)
    end
    else
    begin
    Set @PointsID ='0'
    end

    RETURN @PointsID
END